# https://github.com/alainmarcel/Surelog/issues/631
# https://github.com/alainmarcel/Surelog/pull/847

_realname=surelog
pkgbase=mingw-w64-${_realname}
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=master
pkgrel=1
pkgdesc="DESCRIPTION (mingw-w64)"
arch=('any')
url="URL"
license=('license')
depends=("${MINGW_PACKAGE_PREFIX}-gcc-libs")
makedepends=("${MINGW_PACKAGE_PREFIX}-gcc"
             "${MINGW_PACKAGE_PREFIX}-cmake"
             "${MINGW_PACKAGE_PREFIX}-ninja"
             "${MINGW_PACKAGE_PREFIX}-openssl"
             "${MINGW_PACKAGE_PREFIX}-zlib"
             "${MINGW_PACKAGE_PREFIX}-tcl")

source=("surelog::git://github.com/alainmarcel/${_realname}.git#commit=${pkgver}")
sha256sums=('SKIP')

build() {
  export PATH="$(cat ~/.JAVA_HOME)":$PATH
  export CMAKE_GENERATOR=Ninja
  export CC=gcc
  export CXX=g++
  export NO_TCMALLOC=On

  cd ${srcdir}/surelog

  git submodule update --init --recursive

  make release
}

package() {
  cd ${srcdir}/surelog
  make DESTDIR="${pkgdir}" install
  make DESTDIR="${pkgdir}" test_install
}

test() {
  cd ${srcdir}/surelog
  make test/unittest
  time make CPU_CORES=2 regression
}
