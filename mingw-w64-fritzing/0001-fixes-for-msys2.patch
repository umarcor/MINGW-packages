From 9b6b68dd85379616c85b7fef1a99fb50ad598770 Mon Sep 17 00:00:00 2001
From: umarcor <unai.martinezcorral@ehu.eus>
Date: Mon, 1 Mar 2021 22:27:47 +0100
Subject: [PATCH] fixes for msys2

---
 phoenix.pro               | 43 +++++++++++++++++++++++----------------
 pri/libgit2detect.pri     |  4 ++--
 src/utils/folderutils.cpp |  5 ++++-
 3 files changed, 31 insertions(+), 21 deletions(-)

diff --git a/phoenix.pro b/phoenix.pro
index 2abf6d0d..a4482772 100644
--- a/phoenix.pro
+++ b/phoenix.pro
@@ -33,7 +33,7 @@ CONFIG += c++14
 # TODO: Verify flags for clang and msvc builds
 QMAKE_CXXFLAGS += -O3 -fno-omit-frame-pointer
 
-unix:!macx {
+if(unix:!macx)|mingw {
     CONFIG += link_pkgconfig
 }
 
@@ -47,6 +47,9 @@ win32 {
     DEFINES += _CRT_SECURE_NO_DEPRECATE
     DEFINES += _WINDOWS
     RELEASE_SCRIPT = $$(RELEASE_SCRIPT)    # environment variable set from release script
+    mingw:isEmpty(QMAKE_TARGET.arch) {
+        QMAKE_TARGET.arch = $$(MSYSTEM_CARCH)
+    }
 
     message("target arch: $${QMAKE_TARGET.arch}")
     contains(QMAKE_TARGET.arch, x86_64) {
@@ -58,17 +61,19 @@ win32 {
         DEBDIR = ../debug32
     }
 
-    Release:DESTDIR = $${RELDIR}
-    Release:OBJECTS_DIR = $${RELDIR}
-    Release:MOC_DIR = $${RELDIR}
-    Release:RCC_DIR = $${RELDIR}
-    Release:UI_DIR = $${RELDIR}
-
-    Debug:DESTDIR = $${DEBDIR}
-    Debug:OBJECTS_DIR = $${DEBDIR}
-    Debug:MOC_DIR = $${DEBDIR}
-    Debug:RCC_DIR = $${DEBDIR}
-    Debug:UI_DIR = $${DEBDIR}
+    !mingw {
+        Release:DESTDIR = $${RELDIR}
+        Release:OBJECTS_DIR = $${RELDIR}
+        Release:MOC_DIR = $${RELDIR}
+        Release:RCC_DIR = $${RELDIR}
+        Release:UI_DIR = $${RELDIR}
+
+        Debug:DESTDIR = $${DEBDIR}
+        Debug:OBJECTS_DIR = $${DEBDIR}
+        Debug:MOC_DIR = $${DEBDIR}
+        Debug:RCC_DIR = $${DEBDIR}
+        Debug:UI_DIR = $${DEBDIR}
+    }
 }
 macx {
     RELDIR = ../release64
@@ -96,13 +101,15 @@ macx {
     LIBS += /System/Library/Frameworks/IOKit.framework/Versions/A/IOKit
     LIBS += -liconv
 }
-unix {
+unix|mingw {
     !macx { # unix is defined on mac
-        HARDWARE_PLATFORM = $$system(uname -m)
-        contains(HARDWARE_PLATFORM, x86_64) {
-            DEFINES += LINUX_64
-        } else {
-            DEFINES += LINUX_32
+        !mingw {
+            HARDWARE_PLATFORM = $$system(uname -m)
+            contains(HARDWARE_PLATFORM, x86_64) {
+                DEFINES += LINUX_64
+            } else {
+                DEFINES += LINUX_32
+            }
         }
         !contains(DEFINES, QUAZIP_INSTALLED) {
             LIBS += -lz
diff --git a/pri/libgit2detect.pri b/pri/libgit2detect.pri
index f8dae314..5fbd177f 100644
--- a/pri/libgit2detect.pri
+++ b/pri/libgit2detect.pri
@@ -34,7 +34,7 @@ if ($$LIBGIT_STATIC) {
     INCLUDEPATH += $$LIBGIT2INCLUDE
 }
 
-win32 {
+win32:!mingw {
     contains(QMAKE_TARGET.arch, x86_64) {
         LIBGIT2LIB = "$$_PRO_FILE_PWD_/../libgit2/build64/Release"
     } else {
@@ -51,7 +51,7 @@ win32 {
     message($$PKGCONFIG)
 }
 
-unix {
+unix|mingw {
     if ($$LIBGIT_STATIC) {
         LIBGIT2LIB = $$_PRO_FILE_PWD_/../libgit2/build
         exists($$LIBGIT2LIB/libgit2.a) {
diff --git a/src/utils/folderutils.cpp b/src/utils/folderutils.cpp
index f1652107..b6371e04 100644
--- a/src/utils/folderutils.cpp
+++ b/src/utils/folderutils.cpp
@@ -212,7 +212,7 @@ const QString FolderUtils::libraryPath()
 
 const QString FolderUtils::applicationDirPath() {
 	if (m_appPath.isEmpty()) {
-#ifdef Q_OS_WIN
+#if defined(Q_OS_WIN) && !defined(__MINGW32__)
 		m_appPath = QCoreApplication::applicationDirPath();
 #else
 		// look in standard Fritzing location (applicationDirPath and parent folders) then in standard linux locations
@@ -220,6 +220,9 @@ const QString FolderUtils::applicationDirPath() {
 		candidates.append(QCoreApplication::applicationDirPath());
 		QDir dir(QCoreApplication::applicationDirPath());
 		if (dir.cdUp()) {
+#ifdef __MINGW32__
+			candidates.append(QDir::cleanPath(dir.absolutePath() + "/share/fritzing"));
+#endif
 			candidates.append(dir.absolutePath());
 			if (dir.cdUp()) {
 				candidates.append(dir.absolutePath());
-- 
2.30.1

